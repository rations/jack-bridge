#!/bin/sh
### BEGIN INIT INFO
# Provides:          jack-bridge-dbus
# Required-Start:    $local_fs $remote_fs dbus
# Required-Stop:     $local_fs $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: D-Bus service for qjackctl integration with jack-bridge
# Description:       Provides org.jackaudio.service D-Bus interface to bridge
#                    qjackctl's expectations with jack-bridge's SysV init system
### END INIT INFO

# contrib/init.d/jack-bridge-dbus - SysV init script for D-Bus bridge service

. /lib/lsb/init-functions

DAEMON=/usr/local/bin/jack-bridge-dbus
PIDFILE=/var/run/jack-bridge-dbus.pid
NAME=jack-bridge-dbus
DESC="JACK D-Bus bridge service"

# Check if daemon exists
test -x $DAEMON || exit 0

case "$1" in
    start)
        log_daemon_msg "Starting $DESC" "$NAME"
        
        # Check if already running
        if [ -f $PIDFILE ]; then
            pid=$(cat $PIDFILE 2>/dev/null || true)
            if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
                log_progress_msg "already running"
                log_end_msg 0
                exit 0
            fi
            # Stale pidfile
            rm -f $PIDFILE 2>/dev/null || true
        fi
        
        # Start daemon
        start-stop-daemon --start --background --make-pidfile \
            --pidfile $PIDFILE --exec $DAEMON \
            || { log_failure_msg "Failed to start $NAME"; log_end_msg 1; exit 1; }
        
        log_end_msg 0
        ;;
        
    stop)
        log_daemon_msg "Stopping $DESC" "$NAME"
        
        # Check if running
        if [ ! -f $PIDFILE ]; then
            log_progress_msg "not running"
            log_end_msg 0
            exit 0
        fi
        
        pid=$(cat $PIDFILE 2>/dev/null || true)
        if [ -z "$pid" ] || ! kill -0 "$pid" 2>/dev/null; then
            log_progress_msg "not running"
            rm -f $PIDFILE 2>/dev/null || true
            log_end_msg 0
            exit 0
        fi
        
        # Stop daemon
        start-stop-daemon --stop --pidfile $PIDFILE --retry=TERM/5/KILL/2 --oknodo
        rm -f $PIDFILE 2>/dev/null || true
        
        log_end_msg 0
        ;;
        
    restart|force-reload)
        $0 stop
        sleep 1
        $0 start
        ;;
        
    status)
        if [ -f $PIDFILE ]; then
            pid=$(cat $PIDFILE 2>/dev/null)
            if [ -n "$pid" ] && kill -0 "$pid" >/dev/null 2>&1; then
                echo "$NAME running (pid $pid)"
                exit 0
            fi
        fi
        echo "$NAME not running"
        exit 1
        ;;
        
    *)
        echo "Usage: $0 {start|stop|restart|force-reload|status}"
        exit 2
        ;;
esac

exit 0