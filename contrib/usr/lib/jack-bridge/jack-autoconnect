#!/bin/sh
# contrib/usr/lib/jack-bridge/jack-autoconnect
# Idempotent auto-connect of ALSA pcm outputs to a default sink and then
# honor a preferred target using jack-route-select if configured.
# Safe to call multiple times; suppress errors.

: ${JACK_AUTOCONNECT_LOOPBACK:=0}
ROUTE_HELPER="/usr/local/lib/jack-bridge/jack-route-select"
DEVCONF="/etc/jack-bridge/devices.conf"

# Allow override from /etc/default/jackd-rt if present
if [ -r /etc/default/jackd-rt ]; then
    . /etc/default/jackd-rt
fi

# small delay to let jack ports appear
sleep 2

# Helper: try connecting if both ports exist
try_connect() {
    from="$1"
    to="$2"
    if jack_lsp 2>/dev/null | grep -q "^${from}$" && jack_lsp 2>/dev/null | grep -q "^${to}$"; then
        jack_connect "$from" "$to" 2>/dev/null || true
    fi
}

# Default wiring to internal system playback as a baseline
try_connect "alsa_pcm:playback_1" "system:playback_1"
try_connect "alsa_pcm:playback_2" "system:playback_2"

# Optional mic monitoring
if [ "x$JACK_AUTOCONNECT_LOOPBACK" = "x1" ]; then
    try_connect "system:capture_1" "system:playback_1"
    try_connect "system:capture_2" "system:playback_2"
fi

# Optional route-select auto-routing (disabled by default).
# To enable, set AUTOROUTE=1 in /etc/jack-bridge/devices.conf (or export AUTOROUTE=1).
AUTOROUTE="${AUTOROUTE:-0}"
if [ -r "$DEVCONF" ]; then
    # shellcheck disable=SC1090
    . "$DEVCONF"
fi

if [ "x$AUTOROUTE" = "x1" ]; then
    case "$PREFERRED_OUTPUT" in
      internal|usb|hdmi|bluetooth)
        if [ -x "$ROUTE_HELPER" ]; then
            "$ROUTE_HELPER" "$PREFERRED_OUTPUT" >/dev/null 2>&1 || true
        fi
        ;;
    esac
fi

exit 0