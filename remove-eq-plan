Plan to remove ALSA EQ (equal plugin) while keeping recorder and all other features working

1. Target audio pipeline (no EQ)
Current effective playback chain from asound.conf and 50-jack.conf:

ALSA app → pcm.!default → pcm.equal → pcm.plugequal (type equal) → pcm.jack → JACK → system|usb_out|hdmi_out|bluealsa ports.
Target chain after changes:

ALSA app → pcm.!default → pcm.jack → JACK → system|usb_out|hdmi_out|bluealsa ports.
Recorder already uses JACK directly:

start_recording() runs arecord -D jack ... and uses pcm.jack from 50-jack.conf.
This path is independent of the EQ plugin and will remain unchanged.
Constraints:

Mixer UI (card 0, USB, HDMI) in mxeq must keep working.
Device switching (Internal/USB/HDMI/Bluetooth) via create_devices_panel() and jack-route-select must keep working.
Bluetooth discovery and routing via gui_bt_* helpers, create_bt_panel(), on_bt_set_output_clicked(), and jackbridge_bluealsa must keep working.
Recorder in create_recorder_ui() must keep working.
JACK‑side services and scripts (jackd-rt, jack-bridge-ports, jack-connection-manager, jack-autoconnect, jack-bridge-dbus) must not need changes.
2. ALSA configuration changes (system level)
Redefine /etc/asound.conf without EQ

Edit asound.conf:
Remove these blocks entirely:
ctl.equal { type equal; }
pcm.plugequal { type equal; slave.pcm "jack"; }
pcm.equal { type plug; slave.pcm plugequal; }
Replace pcm.!default block with a direct JACK plug:
pcm.!default { type plug; slave.pcm "jack" }
Do not touch:
All pcm.input_card0_*, pcm.input_usb_*, pcm.input_hdmi_*, pcm.input_bt_* definitions.
pcm.bluealsa definition.
ctl.!default { type hw; card 0 }.
Confirm compatibility with per‑user overrides

Per‑user input routing is managed by:
compose_user_current_input_conf() and write_user_current_input_conf(), which write ~/.config/jack-bridge/current_input.conf defining pcm.current_input.
ensure_user_asoundrc_bootstrap(), which creates a # BEGIN jack-bridge block in ~/.asoundrc with an include pointing at that fragment.
Per‑user output routing is managed by write_user_output_conf(), which writes pcm.current_output and injects it (plus bluealsa_defaults.conf) into ~/.asoundrc.
These mechanisms only depend on pcm.current_input/pcm.current_output and the BlueALSA PCM names; they do not depend on pcm.equal or ctl.equal. After the change, they continue to function unchanged.
3. Remove EQ from the GUI (mxeq) but keep recording
3.1 Remove EQ control and preset logic
Delete EQ data structures and ALSA control use

In mxeq.c:
Remove struct definitions EQBand and EQData once no references remain.
Remove the EQ slider callback eq_slider_changed() that writes to EQBand->ctl/val.
Remove the EQ initialization function init_alsa_eq(), which calls snd_ctl_open(&data->ctl, "equal", 0) and enumerates mixer controls on the equal device.
Remove all uses of eq_data (e.g. EQData eq_data = {0}; and init_alsa_eq(&eq_data); in main).
Remove EQ presets and CSV file handling

Delete preset management functions in mxeq.c:
save_preset() (writes to ~/.local/share/mxeq/presets.csv).
apply_preset() (reads presets file and pushes values to EQ sliders and EQ ALSA control).
load_presets().
Remove all widget wiring for presets in the UI section:
preset_box, preset_entry, save_button, preset_combo, and the spacer labels created around preset_box.
The g_object_set_data() calls that attach preset_entry, preset_combo, and window to save_button (around g_object_set_data).
The g_signal_connect() calls that bind save_preset and apply_preset to the widgets (around g_signal_connect(save_button, ...)).
Result: ~/.local/share/mxeq/presets.csv becomes unused but can remain on disk as user data.
3.2 Turn the "EQ and Recording" expander into Recording‑only
Simplify the expander content

In main UI construction in mxeq.c:
Change the expander text from "EQ and Recording" to "Recording" (or similar) in gtk_expander_new.
Keep the expander instance and its integration with on_any_expander_toggled() so window resizing behaviour remains the same.
Remove the EQ band UI:
Delete the GtkWidget *eq_box = gtk_box_new(...) and surrounding EQ band creation loop starting from eq_box and for (int i = 0; i < eq_data.num_bands; i++).
Keep the Recorder UI:
Retain the call create_recorder_ui(eq_content_vbox) so the recorder frame, filename entry, channel/rate combos, and Record/Stop buttons remain exactly as today.
Adjust initialization and cleanup

In main of mxeq.c:
Remove EQData eq_data = {0};.
Remove the call init_alsa_eq(&eq_data); at init_alsa_eq.
In cleanup_alsa():
Remove the branch that frees eq_data->bands[i].val, eq_data->bands[i].band_name, and closes eq_data->ctl.
Confirm with a build that no references to EQBand, EQData, eq_data, or the "equal" control remain.
The GUI will then provide:

Mixer panel for the active ALSA card (unchanged): init_alsa_mixer() and rebuild_mixer_for_card().
Bluetooth panel (unchanged): create_bt_panel().
Devices panel for Internal/USB/HDMI/Bluetooth playback (unchanged): create_devices_panel() with routing via on_device_radio_toggled() and jack-route-select.
Recording panel (unchanged behaviour, new layout): create_recorder_ui().
4. Explicit audits of routing helpers and services
Verify jack-route-select is EQ‑agnostic

Inspect jack-route-select:
Confirms it only:
Writes per‑user pcm.current_output and bluealsa_defaults.conf.
Uses JACK ports system:playback_*, usb_out:playback_*, hdmi_out:playback_*, bluealsa:playback_*.
Spawns alsa_out/alsa_in clients and updates JACK routing.
No references to ctl.equal, pcm.equal, or plugequal.
Optionally update comments to say the path is now ALSA → JACK, not ALSA → EQ → JACK.
Verify jack-bridge-ports is EQ‑agnostic

Check jack-bridge-ports:
Detects hardware with aplay -l.
Spawns alsa_out -j usb_out and alsa_out -j hdmi_out and logs via jack_lsp.
No use of equal or pcm.!default.
Verify jack-autoconnect and jack_connection_manager are EQ‑agnostic

jack-autoconnect:
Connects alsa_pcm:playback_1/2 to system:playback_1/2 and optionally calls jack-route-select with PREFERRED_OUTPUT.
Only JACK ports; no ALSA EQ logic.
jack_connection_manager:
Reads PREFERRED_OUTPUT from /etc/jack-bridge/devices.conf and ~/.config/jack-bridge/devices.conf.
Chooses target_sink_prefix among system:playback_, usb_out:playback_, hdmi_out:playback_, bluealsa:playback_.
Uses connect_source_to_sink() to wire new JACK sources.
No dependence on ALSA EQ or default PCM.
Verify jack-bridge-dbus is EQ‑agnostic

jack_bridge_dbus.c only:
Starts/stops jackd-rt via service jackd-rt start|stop (handle_start_server() / handle_stop_server()).
Restarts jack-bridge-ports and jack-connection-manager after a restart.
Reads/writes /etc/default/jackd-rt via jack_bridge_settings_sync.
It has no ALSA or EQ awareness and therefore does not require changes.
5. Installer adjustments
Remove EQ plugin from required packages
In install.sh, update REQUIRED_PACKAGES around line 25:
Remove libasound2-plugin-equal from the list.
No other code paths in the installer depend on the EQ plugin; JACK bridging still uses the standard JACK ALSA plugin (libasound2-plugins) and BlueALSA plugins from contrib/bin.
(Per your instruction, uninstall scripts and README text do not need to be updated at this stage; they can be revised later after behaviour is confirmed.)

6. Rebuild and regression test plan
Rebuild

In the repo root:
Run make clean && make.
Optionally reinstall system components: sudo sh contrib/install.sh.
Smoke tests

Base services
Ensure jackd-rt, bluealsad, jack-bridge-ports, jack-connection-manager, and jack-bridge-dbus start cleanly.
Check logs for absence of ALSA errors about equal or pcm.equal.
ALSA playback → JACK
Run aplay (or an apulse app) and confirm audio appears on system:playback_1/2 in qjackctl.
Use Devices panel in mxeq to switch Internal/USB/HDMI/Bluetooth; verify ports and sound route correctly.
Bluetooth path
Pair and connect in Bluetooth panel create_bt_panel(), then use Set as Output and Devices→Bluetooth.
Confirm bluealsa:playback_1/2 ports appear and audio plays.
Recording
Open the Recording expander (now Recording‑only) and record a WAV.
Confirm arecord -D jack starts successfully and files in ~/Music are valid.
Confirm there are no EQ‑related warnings or errors.
No‑device edge cases
Boot without USB/HDMI to ensure jack-bridge-ports handles placeholder hw:99 / hw:98 correctly.
Test with and without a Bluetooth device connected; ensure only Bluetooth routing is conditional on the device, not anything EQ‑related.
7. Final todo list (for Code mode execution)
The following todos are already recorded via the todo tool and are ready for execution in Code mode:

Define the new target audio pipeline without EQ (ALSA default pcm.!default → pcm.jack) and confirm constraints on mixer, device switching, Bluetooth, and recording behaviour.
Update asound.conf to remove ctl.equal, pcm.plugequal, pcm.equal, and set pcm.!default to a plug over "jack", preserving all pcm.input_* and ctl.!default blocks.
Review interaction between asound.conf, per‑user ~/.asoundrc input overrides from mxeq.c and output overrides from jack-route-select to ensure pcm.current_input/pcm.current_output keep working.
Remove EQ data structures and ALSA "equal" control logic from mxeq.c, including EQBand, EQData, eq_slider_changed(), init_alsa_eq() and all uses of them.
Remove EQ preset handling from mxeq.c (save_preset(), apply_preset(), load_presets()) and their UI wiring, so presets CSV is no longer used.
Simplify the expander in mxeq.c so it becomes Recording‑only and contains only the UI built by create_recorder_ui().
Update initialization and cleanup in mxeq.c and cleanup_alsa() to drop EQ‑related allocation/freeing while keeping mixer and recorder setup unchanged.
Audit jack-route-select to confirm it is EQ‑agnostic and optionally adjust comments to reflect the new ALSA → JACK pipeline.
Audit jack-bridge-ports to ensure it only manages bridge clients and is independent of EQ or default PCM naming.
Audit jack-autoconnect and jack_connection_manager to confirm routing depends solely on JACK ports and is unaffected by EQ removal.
Audit jack_bridge_dbus and related helpers to confirm they only manage services and /etc/default/jackd-rt and are EQ‑agnostic.
Remove libasound2-plugin-equal from REQUIRED_PACKAGES in install.sh and check for any other references to the equal plugin.
Rebuild (make clean && make) and run the smoke tests described above to validate playback, device switching (including Bluetooth), mixer, and recorder behaviour with EQ fully removed.
After all behaviour is verified, plan a separate, documentation‑only change set (e.g. updating README.md and uninstall messaging) to remove EQ from user‑visible docs.
